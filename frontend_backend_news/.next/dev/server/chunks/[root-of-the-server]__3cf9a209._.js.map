{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///D:/1ky-1-nam-4/frontend_cuoiky/frontend_backend_news/src/app/api/videos/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport * as cheerio from 'cheerio';\r\n\r\ninterface VideoItem {\r\n  title: string;\r\n  img: string;\r\n  url: string; // URL bài viết\r\n  timeLabel?: string;\r\n  videoUrl?: string; // ← chỉ gán nếu là YouTube\r\n}\r\n\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n};\r\n\r\nconst normalizeUrl = (url: string): string => {\r\n  if (!url) return '';\r\n  const base = 'https://bongdaplus.vn';\r\n  const trimmed = url.trim();\r\n  return trimmed.startsWith('http') ? trimmed : base + (trimmed.startsWith('/') ? trimmed : '/' + trimmed);\r\n};\r\n\r\nconst fetchVideoUrlFromArticle = async (articleUrl: string): Promise<string | null> => {\r\n  try {\r\n    const res = await fetch(articleUrl, {\r\n      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' },\r\n    });\r\n    if (!res.ok) return null;\r\n\r\n    const html = await res.text();\r\n    const $ = cheerio.load(html);\r\n\r\n    const youtubeIframe = $('iframe[src*=\"youtube.com/embed\"]').first();\r\n    if (youtubeIframe.length > 0) {\r\n      const src = youtubeIframe.attr('src')?.trim();\r\n      if (src) {\r\n        const videoId = new URL(src).pathname.split('/').pop();\r\n        if (videoId) {\r\n          return `https://www.youtube.com/watch?v=${videoId}`;\r\n        }\r\n      }\r\n    }\r\n    return null;\r\n  } catch (err) {\r\n    console.warn(`Không thể lấy video từ ${articleUrl}:`, (err as Error).message);\r\n    return null;\r\n  }\r\n};\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const urlToScrape = 'https://bongdaplus.vn/video';\r\n    console.log(`Đang cào dữ liệu từ: ${urlToScrape}`);\r\n\r\n    const res = await fetch(urlToScrape, {\r\n      headers: { 'User-Agent': 'Mozilla/5.0 (compatible; MyScraper)' },\r\n    });\r\n\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\r\n\r\n    const html = await res.text();\r\n    const $ = cheerio.load(html);\r\n\r\n    const result: {\r\n      diemTin: VideoItem[];\r\n      otherVideos: VideoItem[];\r\n    } = {\r\n      diemTin: [],\r\n      otherVideos: [],\r\n    };\r\n\r\n    const extractVideosByCaption = (captionText: string): VideoItem[] => {\r\n      const section = $(`section.cat-news`).filter((_, el) => {\r\n        return $(el).find('.caption').text().trim() === captionText;\r\n      });\r\n\r\n      const items: VideoItem[] = [];\r\n      section.find('.row.flex .col .media').each((_, el) => {\r\n        const $el = $(el);\r\n        const $thumb = $el.find('a.thumb');\r\n        const title = $el.find('a.title').text().trim() || $thumb.find('img').attr('alt')?.trim() || '';\r\n        const img = $thumb.find('img').attr('src')?.trim() || '';\r\n        const url = $thumb.attr('href')?.trim() || '';\r\n        const timeLabel = $el.find('.info').first().text().trim() || undefined;\r\n\r\n        if (title && img && url) {\r\n          items.push({\r\n            title,\r\n            img: normalizeUrl(img),\r\n            url: normalizeUrl(url),\r\n            timeLabel,\r\n          });\r\n        }\r\n      });\r\n      return items;\r\n    };\r\n\r\n    const diemTinRaw = extractVideosByCaption('Điểm tin');\r\n    const otherVideosRaw = extractVideosByCaption('Video khác');\r\n\r\n    const allItems = [...diemTinRaw, ...otherVideosRaw];\r\n    const videoUrls = await Promise.all(\r\n      allItems.map(item => fetchVideoUrlFromArticle(item.url))\r\n    );\r\n\r\n    const validItems = allItems.filter((_, index) => videoUrls[index] !== null);\r\n    validItems.forEach((item, index) => {\r\n      item.videoUrl = videoUrls[allItems.indexOf(item)]!;\r\n    });\r\n\r\n    const filteredDiemTin = validItems.filter(item =>\r\n      diemTinRaw.some(raw => raw.url === item.url)\r\n    );\r\n    const filteredOtherVideos = validItems.filter(item =>\r\n      otherVideosRaw.some(raw => raw.url === item.url)\r\n    );\r\n\r\n    result.diemTin = filteredDiemTin;\r\n    result.otherVideos = filteredOtherVideos;\r\n\r\n    return new Response(JSON.stringify(result, null, 2), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json; charset=utf-8', ...corsHeaders },\r\n    });\r\n  } catch (error) {\r\n    console.error('Lỗi khi cào dữ liệu:', error);\r\n    return new Response(\r\n      JSON.stringify({\r\n        error: 'Lỗi khi cào dữ liệu',\r\n        message: (error as Error).message,\r\n      }),\r\n      { status: 500, headers: { 'Content-Type': 'application/json; charset=utf-8', ...corsHeaders } }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function OPTIONS() {\r\n  return new Response(null, { status: 200, headers: corsHeaders });\r\n}"],"names":[],"mappings":"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"}}]
}