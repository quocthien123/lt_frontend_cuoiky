{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///D:/codeJavaScript/lt_frontend_cuoiky/frontend_backend_news/src/app/api/videos/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\nimport * as cheerio from 'cheerio';\n\ninterface VideoItem {\n  title: string;\n  img: string;\n  url: string; // URL bài viết\n  timeLabel?: string;\n  videoUrl?: string; // ← chỉ gán nếu là YouTube\n}\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n};\n\nconst normalizeUrl = (url: string): string => {\n  if (!url) return '';\n  const base = 'https://bongdaplus.vn';\n  const trimmed = url.trim();\n  return trimmed.startsWith('http') ? trimmed : base + (trimmed.startsWith('/') ? trimmed : '/' + trimmed);\n};\n\nconst fetchVideoUrlFromArticle = async (articleUrl: string): Promise<string | null> => {\n  try {\n    const res = await fetch(articleUrl, {\n      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' },\n    });\n    if (!res.ok) return null;\n\n    const html = await res.text();\n    const $ = cheerio.load(html);\n\n    const youtubeIframe = $('iframe[src*=\"youtube.com/embed\"]').first();\n    if (youtubeIframe.length > 0) {\n      const src = youtubeIframe.attr('src')?.trim();\n      if (src) {\n        const videoId = new URL(src).pathname.split('/').pop();\n        if (videoId) {\n          return `https://www.youtube.com/watch?v=${videoId}`;\n        }\n      }\n    }\n    return null;\n  } catch (err) {\n    console.warn(`Không thể lấy video từ ${articleUrl}:`, (err as Error).message);\n    return null;\n  }\n};\n\nexport async function GET(request: NextRequest) {\n  try {\n    const urlToScrape = 'https://bongdaplus.vn/video';\n    console.log(`Đang cào dữ liệu từ: ${urlToScrape}`);\n\n    const res = await fetch(urlToScrape, {\n      headers: { 'User-Agent': 'Mozilla/5.0 (compatible; MyScraper)' },\n    });\n\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\n\n    const html = await res.text();\n    const $ = cheerio.load(html);\n\n    const result: {\n      diemTin: VideoItem[];\n      otherVideos: VideoItem[];\n    } = {\n      diemTin: [],\n      otherVideos: [],\n    };\n\n    const extractVideosByCaption = (captionText: string): VideoItem[] => {\n      const section = $(`section.cat-news`).filter((_, el) => {\n        return $(el).find('.caption').text().trim() === captionText;\n      });\n\n      const items: VideoItem[] = [];\n      section.find('.row.flex .col .media').each((_, el) => {\n        const $el = $(el);\n        const $thumb = $el.find('a.thumb');\n        const title = $el.find('a.title').text().trim() || $thumb.find('img').attr('alt')?.trim() || '';\n        const img = $thumb.find('img').attr('src')?.trim() || '';\n        const url = $thumb.attr('href')?.trim() || '';\n        const timeLabel = $el.find('.info').first().text().trim() || undefined;\n\n        if (title && img && url) {\n          items.push({\n            title,\n            img: normalizeUrl(img),\n            url: normalizeUrl(url),\n            timeLabel,\n          });\n        }\n      });\n      return items;\n    };\n\n    const diemTinRaw = extractVideosByCaption('Điểm tin');\n    const otherVideosRaw = extractVideosByCaption('Video khác');\n\n    const allItems = [...diemTinRaw, ...otherVideosRaw];\n    const videoUrls = await Promise.all(\n      allItems.map(item => fetchVideoUrlFromArticle(item.url))\n    );\n\n    const validItems = allItems.filter((_, index) => videoUrls[index] !== null);\n    validItems.forEach((item, index) => {\n      item.videoUrl = videoUrls[allItems.indexOf(item)]!;\n    });\n\n    const filteredDiemTin = validItems.filter(item =>\n      diemTinRaw.some(raw => raw.url === item.url)\n    );\n    const filteredOtherVideos = validItems.filter(item =>\n      otherVideosRaw.some(raw => raw.url === item.url)\n    );\n\n    result.diemTin = filteredDiemTin;\n    result.otherVideos = filteredOtherVideos;\n\n    return new Response(JSON.stringify(result, null, 2), {\n      status: 200,\n      headers: { 'Content-Type': 'application/json; charset=utf-8', ...corsHeaders },\n    });\n  } catch (error) {\n    console.error('Lỗi khi cào dữ liệu:', error);\n    return new Response(\n      JSON.stringify({\n        error: 'Lỗi khi cào dữ liệu',\n        message: (error as Error).message,\n      }),\n      { status: 500, headers: { 'Content-Type': 'application/json; charset=utf-8', ...corsHeaders } }\n    );\n  }\n}\n\nexport async function OPTIONS() {\n  return new Response(null, { status: 200, headers: corsHeaders });\n}"],"names":[],"mappings":"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"}}]
}