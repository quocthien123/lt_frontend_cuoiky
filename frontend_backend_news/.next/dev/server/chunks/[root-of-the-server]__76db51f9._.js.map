{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///D:/1ky-1-nam-4/frontend_cuoiky/frontend_backend_news/src/app/api/get-new-description/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport * as cheerio from 'cheerio';\r\nimport { Article } from '../bongdaplus/types';\r\nimport axios from 'axios';\r\n\r\n// Headers để tránh lỗi CORS\r\nconst corsHeaders = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Methods': 'GET, OPTIONS',\r\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n};\r\n\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n  const searchParams = request.nextUrl.searchParams;\r\n  const slug = searchParams.get('slug');\r\n  const category = searchParams.get('category');\r\n  let title = '';\r\n  //if (!slug) {\r\n    //return NextResponse.json(\r\n     // { success: false, message:'Thiếu slug'},\r\n    //  { status: 400, headers: corsHeaders }\r\n   // );\r\n // }\r\n        //https://bongdaplus.vn/bong-da-viet-nams\r\n        //https://bongdaplus.vn/${category}/${slug}\r\n\r\n  const urlToScrape = `https://bongdaplus.vn/${category}/${slug}`;\r\n  console.log(`Đang cào dữ liệu từ: ${urlToScrape}`);\r\nconst res = await fetch(urlToScrape, {\r\n      headers: { 'User-Agent': 'Mozilla/5.0 (compatible; MyScraper)' },\r\n    });\r\n\r\n    if (!res.ok) throw new Error('Không thể truy cập trang đích');\r\n  const html = await res.text();\r\n   const $ = cheerio.load(html);\r\n\r\n// --- Lấy tóm tắt ---\r\nconst summaryEl = $('.summary.bdr').first();\r\nconst summary = summaryEl.find('b').text().trim(); // Vì tóm tắt nằm trong <b>\r\n\r\n\r\n// --- Lấy nội dung chính theo thứ tự ---\r\nconst contentBlocks: { type: string; content: string }[] = [];\r\nlet relatedArticles = [];\r\n$('#postContent').children().each((_, el) => {\r\n  const $el = $(el);\r\n  const tagName = $el[0].tagName;\r\n  \r\n  // Bỏ qua quảng cáo (dựa trên đặc điểm bạn cung cấp)\r\n  if (\r\n    $el.find('script, ins, .adsbyeclick, [data-type=\"_mgwidget\"]').length > 0 ||\r\n    $el.closest('[data-type=\"_mgwidget\"]').length > 0 ||\r\n    $el.attr('class')?.includes('gm') ||\r\n    $el.html()?.includes('clck.mgid.com') // hoặc các pattern quảng cáo khác\r\n  ) {\r\n    return; // skip quảng cáo\r\n  }\r\n   title = $('.lead-title h1').text().trim();\r\n  if (tagName === 'p') {\r\n    // Trường hợp 1: <p> chỉ chứa text → block văn bản\r\n    const imgInP = $el.find('img');\r\n    if (imgInP.length > 0) {\r\n      // Trường hợp 2: <p> chứa hình ảnh → xử lý ảnh + caption\r\n      const imgSrc = imgInP.attr('src')?.trim() || '';\r\n      const altText = $el.find('.alt').text().trim() || imgInP.attr('alt')?.trim() || '';\r\n\r\n      if (imgSrc) {\r\n        contentBlocks.push({ type: 'image', content: imgSrc });\r\n        if (altText) {\r\n          contentBlocks.push({ type: 'caption', content: altText });\r\n        }\r\n      }\r\n\r\n      // Ngoài ảnh, nếu <p> còn có text ở ngoài img (hiếm, nhưng có thể), xử lý thêm:\r\n      // Ta clone rồi xóa img đi để lấy text còn lại\r\n      const $clone = $el.clone();\r\n      $clone.find('img, .alt, script, ins').remove();\r\n      const remainingText = $clone.text().trim();\r\n      if (remainingText) {\r\n        contentBlocks.push({ type: 'text', content: remainingText });\r\n      }\r\n    } else {\r\n      // Chỉ có text\r\n      const text = $el.text().trim();\r\n      if (text) {\r\n        contentBlocks.push({ type: 'text', content: text });\r\n      }\r\n    }\r\n  } else if (tagName === 'div' || tagName === 'h4' || tagName === 'blockquote') {\r\n    // Xử lý các thẻ khác nếu cần (vd: h4 quảng cáo sách)\r\n    const text = $el.text().trim();\r\n    if (text && !$el.hasClass('gm') && !$el.attr('data-type')) {\r\n      contentBlocks.push({ type: 'text', content: text });\r\n    }\r\n  }\r\n\r\n});\r\n$('.relates .news a.title').each((_, el) => {\r\n  const $a = $(el);\r\n  const title = $a.text().trim();\r\n  let url = $a.attr('href')?.trim();\r\n  if (title && url) {\r\n    if (!url.startsWith('http')) {\r\n      url = `${url.startsWith('/') ? url : '/' + url}`;\r\n    }\r\n    relatedArticles.push({ title, url });\r\n  }\r\n});\r\n      return NextResponse.json(\r\n      {\r\n        success: true,\r\n        data: {\r\n          title,\r\n          summary,\r\n            contentBlocks,\r\n            relatedArticles,\r\n        },\r\n      },\r\n      {status : 200,\r\n        headers : corsHeaders\r\n      }\r\n    );\r\n  } catch (error) {\r\n    console.log(\"lỗi header : \", error)\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: (error as Error).message,\r\n      },\r\n      { status: 500, \r\n        headers: corsHeaders\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function OPTIONS() {\r\n  return NextResponse.json({}, { headers: corsHeaders });\r\n}"],"names":[],"mappings":"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"}}]
}